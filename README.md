# MessageProcessor

## Обзор

Этот проект предназначен для обработки сообщений. Он предоставляет HTTP API для приема сообщений, сохраняет их в базе данных PostgreSQL, отправляет в Kafka для дальнейшей обработки и предоставляет API для получения статистики по обработанным сообщениям.

**Паттерн Outbox**
   В этом проекте используется паттерн Outbox для надежной доставки сообщений. Когда новое сообщение сохраняется в базу данных, оно также сохраняется в специальной таблице Outbox. Отдельный процесс читает сообщения из этой таблицы и отправляет их в Kafka, обеспечивая сохранность сообщений.

### Требования

- Docker
- Docker Compose
- Go 1.22

## Конфигурация

Файл `config.yaml` в директории `config` содержит настройки для Kafka, PostgreSQL и HTTP-сервера.

## Сборка и Запуск

### Использование Taskfile

1. **Установка Taskfile:**

   Следуйте инструкциям на [официальной странице Taskfile](https://taskfile.dev/#/installation/) для установки.

2. **Запуск приложения:**


### `default`

По умолчанию выполняет следующие задачи в указанном порядке:
1. **Запуск тестов** — проверяет корректность работы кода.
2. **Сборка проекта** — создает Docker-образ и собирает проект внутри контейнера.
3. **Запуск проекта** — запускает Docker-контейнеры с помощью `docker-compose`.


```sh
   task
```

### `tests`

Запускает тесты для проверки корректности работы кода. Это позволяет убедиться, что все тесты проходят успешно.

```sh
   task tests
```

### `build`

Собирает проект в Docker-контейнере. Включает:
1. **Создание Docker-образа** — строит образ на основе `Dockerfile.gobuild`.
2. **Запуск контейнера сборки** — выполняет сборку проекта внутри контейнера и сохраняет результаты.

```sh
   task build
```

### `c`

Запускает Docker-контейнеры в фоновом режиме с использованием `docker-compose`. Эта задача поднимает все необходимые контейнеры для работы приложения.

```sh
   task up
```

### `down`

Останавливает и удаляет Docker-контейнеры, созданные с помощью `docker-compose`. Эта задача очищает ресурсы, освобождая занятые контейнеры и сети.

```sh
   task down
```

## Обработка сообщений

Сообщения обрабатываются на стороне клиента. В данном примере обработка заключается в добавлении к строке "Processed!" и последующей отправке обратно на сервер, где обновляется база данных.

### Пример обработки сообщения

1. Клиент отправляет сообщение на сервер с помощью запроса 
### POST /submit

**Пример запроса:**

```json
{
  "message": "Привет, мир!"
}
```

**Пример ответа сервера:**

```json
{
  "answer": "Message received successfully"
}
```

2. Клиент отправляет обработанное сообщение обратно на сервер.

3. Сервер принимает обработанное сообщение и обновляет базу данных.

### GET /state

Cтатистика по обработанным сообщениям. 

Для примера была добавлена строка со стороны клиента: Processed!

**Пример ответа:**

```json
[
    {
        "id": 1,
        "content": "hi my name is vera",
        "processed_content": "hi my name is vera. Processed!",
        "status": "update"
    },
    {
        "id": 2,
        "content": "i am a robot",
        "processed_content": "i am a robot. Processed!",
        "status": "update"
    },
    {
        "id": 3,
        "content": "go to play in dota",
        "processed_content": "go to play in dota. Processed!",
        "status": "update"
    }
]
```

